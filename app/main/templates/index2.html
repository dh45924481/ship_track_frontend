<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>船舶管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/swiper-bundle.min.css') }}">
    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    <style>
        /* 基础样式重置和全局设置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* 顶部导航栏样式 */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header div {
            font-size: 1.2em;
            font-weight: 500;
        }

        /* Tab页样式 */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin: 0 20px;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1.5em;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            color: white;
            border-bottom: 2px solid white;
        }

        .tab-button:hover {
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* 导航区域样式 */
        .navigation {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
            min-height: 400px;
        }

        /* 顶部按钮组样式 */
        .top-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 10px;
            padding: 0 20px;
        }

        /* 按钮基础样式 */
        .button {
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
            background-color: #28a745;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .button:hover::after {
            width: 300%;
            height: 300%;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .button:active {
            transform: scale(0.95);
        }

        /* 状态指示器样式 */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            top: -6px;
            right: -6px;
            border: 2px solid white;
            transition: all 0.5s ease;
            animation: pulse 2s infinite;
        }

        .status-normal {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        /* 船舶区域样式 */
        .ship-buttons {
            position: relative;
            margin: 40px auto;
            padding: 20px;
            height: 200px;
            width: calc(100% - 400px);
            border: 2px dashed #e0e0e0;
            border-radius: 10px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .ship-button {
            background: white;
            border: 2px solid #28a745;
            color: #28a745;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .ship-button:hover {
            background: #28a745;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
        }

        /* 查询表单样式 */
        .query-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            margin: 20px 0;
        }

        .query-form .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .query-form .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .query-form label {
            font-weight: 600;
            color: #495057;
            margin-right: 8px;
        }

        .query-form input[type="datetime-local"],
        .query-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 200px;
        }

        .query-form select {
            min-width: 100px;
        }

        .query-form input:focus,
        .query-form select:focus {
            border-color: #28a745;
            outline: none;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }

        .query-form .buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .query-form button {
            padding: 8px 20px;
            margin-right: 10px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        th {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px;
            font-weight: 500;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* 表格中的操作按钮 */
        .table-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            background: #28a745;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-action-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* 分页控件样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination input {
            width: 60px;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
        }

        .pagination input:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            margin: 5vh auto;
            padding: 25px;
            position: relative;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            right: 15px;
            top: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            /* 增加点击区域 */
            padding: 15px;
            z-index: 1100;
        }

        /* 添加伪元素来扩大可点击区域 */
        .close-button::before {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            bottom: -10px;
            left: -10px;
            /* 确保伪元素不会影响视觉效果 */
            opacity: 0;
        }

        .close-button:hover {
            background: #ff4444;
            color: white;
            transform: rotate(90deg);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* 点击效果 */
        .close-button:active {
            transform: rotate(90deg) scale(0.95);
        }


        .modal-images {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-images img {
            max-width: 100%;
            margin: 10px 0;
            transition: transform 0.3s ease;
        }

        .modal-images img:hover {
            transform: scale(1.1);
        }

        /* Swiper样式优化 */
        .swiper-container {
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            height: 80vh;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .swiper-slide {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swiper-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .swiper-button-next,
        .swiper-button-prev {
            background-color: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #333;
        }

        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 20px;
        }

        .swiper-pagination-bullet {
            width: 10px;
            height: 10px;
            background: white;
            opacity: 0.6;
        }

        .swiper-pagination-bullet-active {
            opacity: 1;
            background: #28a745;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .ship-buttons {
                width: calc(100% - 200px);
            }
        }

        @media (max-width: 768px) {
            .ship-buttons {
                width: 100%;
                margin: 20px 0;
            }

            .query-form .form-row {
                flex-direction: column;
                align-items: stretch;
            }

            .query-form .buttons {
                margin: 10px 0;
            }
        }

        /* 信息面板样式 */
        .info-panel {
            position: fixed;
            right: 20px;
            top: 80px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .info-panel.show {
            opacity: 1;
            transform: translateX(0);
        }

        .info-panel h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-panel p {
            margin: 5px 0;
            color: #666;
        }

        /* 状态样式 */
        .button-normal {
            background-color: #28a745;
        }

        .button-warning {
            background-color: #ffc107;
        }

        .button-danger {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 船闸位置按钮样式 */
        #sy_duizhong {
            position: absolute;
            top: 200px;
            left: 120px;
            transform: translateY(-50%);
            min-width: 60px !important;
            width: 60px !important;
            padding: 8px 12px !important;
            writing-mode: vertical-rl;
        }

        #sy_chukong {
            position: absolute;
            top: 200px;
            left: 30px;
            transform: translateY(-50%);
            min-width: 60px !important;
            width: 60px !important;
            padding: 8px 12px !important;
            writing-mode: vertical-rl;
        }

        #xy_chukong {
            position: absolute;
            top: 200px;
            right: 30px;
            transform: translateY(-50%);
            min-width: 60px !important;
            width: 60px !important;
            padding: 8px 12px !important;
            writing-mode: vertical-rl;
        }

        #xy_duizhong {
            position: absolute;
            top: 200px;
            right: 120px;
            transform: translateY(-50%);
            min-width: 60px !important;
            width: 60px !important;
            padding: 8px 12px !important;
            writing-mode: vertical-rl;
        }

        #sy_qidian {
            position: absolute;
            left: 20px;
            top: 330px;
        }

        #xy_piaofuwu {
            position: absolute;
            right: 20px;
        }

        #xy_qidian {
            position: absolute;
            right: 20px;
            top: 330px;
        }

        #xy_jingjie {
            position: absolute;
            right: 270px;
            top: 330px;
        }

        #sy_jingjie {
            position: absolute;
            left: 270px;
        }

        #xyz_xilan {
            position: absolute;
            right: 500px;
            top: 330px;
        }

        #xyy_xilan {
            position: absolute;
            right: 500px;
        }

        #syz_xilan {
            position: absolute;
            left: 500px;
            top: 330px;
        }

        #syy_xilan {
            position: absolute;
            left: 500px;
        }

        #openDoorSafe_Downstream {
            position: absolute;
            right: 270px;
        }

        #openDoorSafe_Upstream {
            position: absolute;
            left: 270px;
            top: 330px;
        }

        #huanlan {
            position: absolute;
            left: 670px;
            top: 330px;
        }

        .bottom-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
            padding: 0 20px;
        }

        /* 监控区布局容器 */
        .monitor-layout {
            position: relative;
            padding: 2rem;
            display: grid;
            grid-template-areas:
                "top-left top top-right"
                "left center right"
                "bottom-left bottom bottom-right";
            gap: 1.5rem;
            margin: 2rem;
            background: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        /* 中央船闸区域 */
        .lock-chamber-container {
            grid-area: center;
            width: 800px;
            height: 500px;
            background: linear-gradient(180deg, #e8f0fe 0%, #c2e7ff 100%);
            border-radius: 16px;
            position: relative;
            box-shadow: inset 0 0 40px rgba(26, 115, 232, 0.2);
            border: 2px solid rgba(26, 115, 232, 0.1);
            overflow: hidden;
        }

        .lock-chamber-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(180deg, transparent, rgba(26, 115, 232, 0.1));
            pointer-events: none;
        }

        /* 按钮组样式 */
        .button-group {
            display: flex;
            gap: 1rem;
            flex-direction: column;
        }

        .button-group.top {
            grid-area: top;
            justify-content: center;
            flex-direction: row;
        }

        .button-group.bottom {
            grid-area: bottom;
            justify-content: center;
            flex-direction: row;
        }

        .button-group.left {
            grid-area: left;
        }

        .button-group.right {
            grid-area: right;
        }

        /* 按钮样式优化 */
        .button {
            background: white;
            border: 1px solid rgba(26, 115, 232, 0.2);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .button::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
        }

        .button.warning::after {
            background: var(--warning-color);
        }

        .button.danger::after {
            background: var(--danger-color);
        }

        /* 船舶样式 */
        .ship {
            position: absolute;
            width: 120px;
            height: 40px;
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
        }

        .ship::before,
        .ship::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
        }

        .ship::before {
            left: -15px;
            border-right: 15px solid #1a73e8;
        }

        .ship::after {
            right: -15px;
            border-left: 15px solid #4285f4;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>船舶运河智慧船闸</div>
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="main">主页</button>
            <button class="tab-button" data-tab="history">详情</button>
        </div>
        <div id="datetime"></div>
    </div>

    <div class="info-panel" id="infoPanel" style="display: none;">
        <h3>船舶信息</h3>
        <div id="shipInfo"></div>
    </div>

    <!-- 主页内容 -->
    <div class="tab-content active" id="main-tab">
        <div class="navigation">
            <button class="button" id="sy_piaofuwu">上游漂浮物检测</button>
            <button class="button" id="syy_xilan">上游右-系缆识别</button>
            <button class="button" id="xyy_xilan">下游右-系缆识别</button>
            <button class="button" id="huanlan">换缆提醒</button>
            <button class="button" id="sy_duizhong">上游闸门对中识别</button>
            <button class="button" id="sy_chukong">上游出空检测</button>
            <button class="button" id="xy_piaofuwu">下游漂浮物检测</button>
            <button class="button" id="openDoorSafe_Downstream">下游闸门上方行人检测</button>
            <button class="button" id="sy_jingjie">上游超警戒线检测</button>

            <div class="ship-buttons" id="shipContainer">
                <!-- 船舶按钮将通过JavaScript动态添加 -->
            </div>

            <button class="button" id="openDoorSafe_Upstream">上游闸门上方行人检测</button>
            <button class="button" id="xy_qidian" style="visibility: hidden;">下游起点检测</button>
            <button class="button" id="syz_xilan">上游左-系缆识别</button>
            <button class="button" id="xyz_xilan">下游左-系缆识别</button>
            <button class="button" id="sy_qidian" style="visibility: hidden;">上游起点检测</button>
            <button class="button" id="xy_jingjie">下游超警戒线检测</button>
            <button class="button" id="xy_duizhong">下游闸门对中识别</button>
            <button class="button" id="xy_chukong">下游出空检测</button>
        </div>

        <!-- 直接显示表格，移除了查询表单 -->
        <table id="shipTable">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>编号</th>
                    <th>方向点位</th>
                    <th>时间</th>
                    <th>船舶号码</th>
                    <th>状态</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
                <!-- 表格内容将通过JavaScript动态更新 -->
            </tbody>
        </table>
        <div class="pagination" id="mainPagination"></div>
    </div>

    <!-- 历史记录tab页 -->
    <div class="tab-content" id="history-tab" style="display: none;">
        <div class="query-form">
            <form id="historyQueryForm">
                <div class="form-row">
                    <div class="input-container">
                        <label for="historyStartTime">开始时间:</label>
                        <input type="datetime-local" id="historyStartTime" name="startTime">
                        <label for="historyEndTime">结束时间:</label>
                        <input type="datetime-local" id="historyEndTime" name="endTime">
                        <label for="historyMonitorPoint">方向点位:</label>
                        <select id="historyMonitorPoint" name="monitorPoint">
                            <option value="201">201</option>
                            <option value="202">202</option>
                            <option value="101">101</option>
                            <option value="102">102</option>
                        </select>
                        <label for="historyDirection">上下行:</label>
                        <select id="historyDirection" name="direction">
                            <option value="upstream">上行</option>
                            <option value="downstream">下行</option>
                        </select>
                        <label for="historyShipName">船名:</label>
                        <input type="text" id="historyShipName" name="shipName">
                    </div>
                    <div class="button-container">
                        <button type="submit">查询</button>
                        <button type="reset">重置</button>
                    </div>
                </div>
            </form>
        </div>

        <table id="historyShipTable">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>编号</th>
                    <th>方向点位</th>
                    <th>时间</th>
                    <th>船舶号码</th>
                    <th>状态</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
                <!-- 历史记录表格内容将通过JavaScript动态更新 -->
            </tbody>
        </table>
        <div class="pagination" id="historyPagination"></div>
    </div>




    <!-- 模态框 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="swiper-container">
                <div class="swiper-wrapper">
                    <!-- 图片将通过JavaScript动态插入 -->
                </div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
    </div>
    <script>
        // 初始化Socket.IO客户端
        var socket = io();

        // 从模板中获取初始的 currentPage 和 totalPages
        var currentPage = 1;
        var totalPages = 1;

        // Tab切换功能
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 移除所有活动状态
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');

                    // 激活当前tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    const currentTab = document.getElementById(`${tabId}-tab`);
                    currentTab.style.display = 'block';

                    // 如果切换到历史记录标签，更新表格数据
                    if (tabId === 'history') {
                        updateHistoryTable(1);
                    }
                });
            });

            // 初始化显示主页
            document.getElementById('main-tab').style.display = 'block';
        });

        // 模拟船舶数据，实际应用中应从服务器获取
        const ships = [
            { name: "远宁998", x: 10, y: 10, status: "正常" },
            { name: "运沙船", x: 10, y: 80, status: "警告" }
        ];

        function createShipButtons() {
            const container = document.getElementById('shipContainer');
            ships.forEach(ship => {
                const button = document.createElement('button');
                button.className = 'ship-button';
                button.textContent = ship.name;
                button.style.left = ship.x + 'px';
                button.style.top = ship.y + 'px';

                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'status-indicator';
                button.appendChild(statusIndicator);

                container.appendChild(button);
                setupDragListeners(button);
            });
        }



        // 下游出空检测
        function createxychukong() {
            setInterval(() => {
                fetch('/getOut208')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xy_chukong');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#28a745' : '#dc3545';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游出空检测
        function createsychukong() {
            setInterval(() => {
                fetch('/getOut210')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('sy_chukong');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#28a745' : '#dc3545';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游对中检测
        function createxyduizhong() {
            setInterval(() => {
                fetch('/getOut115')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xy_duizhong');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].status == 1 ? '#28a745' : '#dc3545';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游人员检测
        function createOpenDoorSafeUpButtons() {
            setInterval(() => {
                fetch('/openDoorSafe_up')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('openDoorSafe_Upstream');
                        if (button && data.data && data.data.length > 0) {
                            const person = data.data[0];
                            const color = (person.has_person_1 == 1 || person.has_person_2 == 1) ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游人员检测
        function createOpenDoorSafeDownButtons() {
            setInterval(() => {
                fetch('/openDoorSafe_down')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('openDoorSafe_Downstream');
                        if (button && data.data && data.data.length > 0) {
                            const person = data.data[0];
                            const color = (person.has_person_1 == 1 || person.has_person_2 == 1) ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游右系缆识别
        function create_syy_xilanButtons() {
            setInterval(() => {
                fetch('/openDoorEvent_syy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('syy_xilan');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游左系缆识别
        function create_syz_xilanButtons() {
            setInterval(() => {
                fetch('/openDoorEvent_syz')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('syz_xilan');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游右系缆识别
        function create_xyy_xilanButtons() {
            setInterval(() => {
                fetch('/openDoorEvent_xyy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xyy_xilan');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游左系缆识别
        function create_xyz_xilanButtons() {
            setInterval(() => {
                fetch('/openDoorEvent_xyz')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xyz_xilan');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].type == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游超警戒线检测
        function createdangerdatasyButtons() {
            setInterval(() => {
                fetch('/dist_danger_sy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('sy_jingjie');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].dist_danger == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游超警戒线检测
        function createdangerdataxyButtons() {
            setInterval(() => {
                fetch('/dist_danger_xy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xy_jingjie');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].dist_danger == 0 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 上游漂浮物检测
        function create_floating_Buttons_sy() {
            setInterval(() => {
                fetch('/gate_floating_monitoring_sy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('sy_piaofuwu');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].has_floater == 1 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 下游漂浮物检测
        function create_floating_Buttons_xy() {
            setInterval(() => {
                fetch('/gate_floating_monitoring_xy')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('xy_piaofuwu');
                        if (button && data.data && data.data.length > 0) {
                            const color = data.data[0].has_floater == 1 ? '#dc3545' : '#28a745';
                            button.style.setProperty('background-color', color, 'important');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 换缆提醒
        function create_cable_Buttons() {
            setInterval(() => {
                fetch('/change_cable')
                    .then(response => response.json())
                    .then(data => {
                        const button = document.getElementById('huanlan');
                        if (button && data.data && data.data.length > 0) {
                            if (data.data[0].huanlan_flag == 1) {
                                button.style.setProperty('background-color', '#dc3545', 'important');
                                setTimeout(() => {
                                    button.style.setProperty('background-color', '#28a745', 'important');
                                }, 300000);
                            } else {
                                button.style.setProperty('background-color', '#28a745', 'important');
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }, 5000);
        }

        // 更新时间显示
        function updateDateTime() {
            const now = new Date();
            const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const formatted = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${days[now.getDay()]} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            document.getElementById('datetime').textContent = formatted;
        }

        // 设置拖拽监听器
        function setupDragListeners(button) {
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            button.addEventListener('mousedown', dragStart);
            button.addEventListener('mousemove', drag);
            button.addEventListener('mouseup', dragEnd);
            button.addEventListener('mouseleave', dragEnd);

            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === button) {
                    isDragging = true;
                    button.classList.add('dragging');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    const container = document.getElementById('shipContainer');
                    const containerRect = container.getBoundingClientRect();

                    const buttonRect = button.getBoundingClientRect();
                    const maxX = containerRect.width - buttonRect.width;
                    const maxY = containerRect.height - buttonRect.height;

                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));

                    button.style.left = currentX + 'px';
                    button.style.top = currentY + 'px';

                    // 发送位置更新到服务器
                    socket.emit('position_update', {
                        ship_name: button.textContent,
                        position: { x: currentX, y: currentY }
                    });
                }
            }

            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
                button.classList.remove('dragging');
            }
        }

        // 处理接收到的船舶更新数据
        socket.on('update_ship', function (data) {
            const button = Array.from(document.getElementsByClassName('ship-button')).find(btn => btn.textContent === data.ship_name);

            if (button) {
                // 更新位置
                if (data.position) {
                    button.style.left = data.position.x + 'px';
                    button.style.top = data.position.y + 'px';
                }

                // 更新状态指示器
                const indicator = button.querySelector('.status-indicator');
                if (indicator) {
                    indicator.className = 'status-indicator status-' + data.status.toLowerCase();
                }

                // 更新信息面板
                updateInfoPanel(data);

                // 更新表格
                // updateTable(data);
                updateTable(1);
            }
        });

        // 更新信息面板
        function updateInfoPanel(data) {
            const panel = document.getElementById('infoPanel');
            const info = document.getElementById('shipInfo');

            info.innerHTML = `
                <p>船名: ${data.ship_name}</p>
                <p>状态: ${data.status}</p>
                <p>更新时间: ${data.timestamp}</p>
            `;

            panel.style.display = 'block';
            setTimeout(() => panel.style.display = 'none', 3000);
        }

        function updateTable(currentPage) {
            currentPage = currentPage || 1;
            fetch('/get_data?currentPage=' + currentPage)
                .then(response => response.json())
                .then(data => {
                    if (!data || !Array.isArray(data.data)) {
                        console.error('Invalid data format:', data);
                        return;
                    }

                    totalPages = data.total_pages;
                    const tbody = document.querySelector('#shipTable tbody');
                    tbody.innerHTML = '';
                    data.data.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        const fields = ['id', 'name', 'direction', 'create_time', 'ship_number', 'status'];
                        fields.forEach(fieldName => {
                            const td = document.createElement('td');
                            td.textContent = row[fieldName] || ''; // 使用 || '' 处理可能不存在的字段
                            tr.appendChild(td);
                        });

                        // 添加最后一列“打开详情”
                        const detailTd = document.createElement('td');
                        const detailLink = document.createElement('button');
                        detailLink.textContent = '详情';
                        detailLink.dataset.id = row.id; // 保存单元格序号到数据属性
                        detailLink.addEventListener('click', () => openDetailModal(detailLink.dataset.id));
                        detailTd.appendChild(detailLink);
                        tr.appendChild(detailTd);
                        tbody.appendChild(tr);
                    });
                    addPaginationButtons(totalPages, currentPage);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // 显示详情
        function showDetails(shipName) {
            alert(`显示 ${shipName} 的详细信息`);
        }

        let originalImages = [];
        function openDetailModal(id) {
            fetch(`/get_images?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    const modal = document.getElementById('detailModal');
                    const swiperWrapper = modal.querySelector('.swiper-wrapper');
                    swiperWrapper.innerHTML = ''; // 清空现有内容

                    // 添加图片到轮播
                    data.images.forEach(imageUrl => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';

                        const img = document.createElement('img');
                        img.src = '/static/images/Snipaste_2024-12-06_14-55-18.png';
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';

                        slide.appendChild(img);
                        swiperWrapper.appendChild(slide);
                    });

                    // 初始化Swiper
                    if (window.mySwiper) {
                        window.mySwiper.destroy(true, true);
                    }

                    window.mySwiper = new Swiper('.swiper-container', {
                        loop: true,
                        navigation: {
                            nextEl: '.swiper-button-next',
                            prevEl: '.swiper-button-prev',
                        },
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true,
                        },
                    });

                    modal.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            if (window.mySwiper) {
                window.mySwiper.destroy(true, true);
            }
            modal.style.display = 'none';
        }

        // 确保事件监听器正确设置
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('detailModal');
            const closeButton = document.querySelector('.close-button');

            closeButton.onclick = closeModal;

            window.onclick = function (event) {
                if (event.target === modal) {
                    closeModal();
                }
            }
        });

        // 添加分页按钮
        const paginationContainer = document.createElement('div');
        paginationContainer.className = 'pagination';
        document.body.appendChild(paginationContainer);

        function addPaginationButtons(totalPages, currentPage) {
            const paginationContainer = document.getElementById('mainPagination');
            paginationContainer.innerHTML = '';

            // 第一页/共多少页
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            paginationContainer.appendChild(pageInfo);

            // 首页按钮
            const firstButton = document.createElement('button');
            firstButton.textContent = '首页 ';
            firstButton.disabled = currentPage === 1;
            firstButton.addEventListener('click', () => {
                if (currentPage !== 1) {
                    currentPage = 1;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });

            paginationContainer.appendChild(firstButton);

            // 上一页按钮
            const prevButton = document.createElement('button');
            prevButton.textContent = '上一页 ';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });
            paginationContainer.appendChild(prevButton);

            // 下一页按钮
            const nextButton = document.createElement('button');
            nextButton.textContent = '下一页 ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });
            paginationContainer.appendChild(nextButton);

            // 尾页按钮
            const lastButton = document.createElement('button');
            lastButton.textContent = '尾页 ';
            lastButton.disabled = currentPage === totalPages;
            lastButton.addEventListener('click', () => {
                if (currentPage !== totalPages) {
                    currentPage = totalPages;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });
            paginationContainer.appendChild(lastButton);

            // 跳转输入框
            const gotoInput = document.createElement('input');
            gotoInput.type = 'number';
            gotoInput.min = 1;
            gotoInput.max = totalPages;
            gotoInput.value = currentPage;
            gotoInput.addEventListener('change', () => {
                const pageNumber = parseInt(gotoInput.value, 10);
                if (pageNumber >= 1 && pageNumber <= totalPages) {
                    currentPage = pageNumber;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });
            paginationContainer.appendChild(gotoInput);

            // 跳转按钮
            const gotoButton = document.createElement('button');
            gotoButton.textContent = '跳转 ';
            gotoButton.addEventListener('click', () => {
                const pageNumber = parseInt(gotoInput.value, 10);
                if (pageNumber >= 1 && pageNumber <= totalPages) {
                    currentPage = pageNumber;
                    updateTable(currentPage);
                    addPaginationButtons(totalPages, currentPage);
                }
            });
            paginationContainer.appendChild(gotoButton);
        }



        // 新增历史记录相关函数
        function updateHistoryTable(currentPage) {
            fetch('/get_history_data?currentPage=' + currentPage)
                .then(response => response.json())
                .then(data => {
                    if (!data || !Array.isArray(data.data)) {
                        console.error('Invalid data format:', data);
                        return;
                    }
                    const tbody = document.querySelector('#historyShipTable tbody');
                    tbody.innerHTML = '';
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        const fields = ['id', 'name', 'direction', 'create_time', 'ship_number', 'status'];
                        fields.forEach(fieldName => {
                            const td = document.createElement('td');
                            td.textContent = row[fieldName] || '';
                            tr.appendChild(td);
                        });

                        const detailTd = document.createElement('td');
                        const detailLink = document.createElement('button');
                        detailLink.textContent = '详情';
                        detailLink.dataset.id = row.id;
                        detailLink.addEventListener('click', () => openDetailModal(detailLink.dataset.id));
                        detailTd.appendChild(detailLink);
                        tr.appendChild(detailTd);
                        tbody.appendChild(tr);
                    });
                    updateHistoryPagination(data.total_pages, currentPage);
                })
                .catch(error => console.error('Error:', error));
        }

        // 更新历史记录分页控件
        function updateHistoryPagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('historyPagination');
            paginationContainer.innerHTML = '';

            // 页码信息
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            paginationContainer.appendChild(pageInfo);

            // 首页按钮
            const firstButton = document.createElement('button');
            firstButton.textContent = '首页';
            firstButton.disabled = currentPage === 1;
            firstButton.addEventListener('click', () => {
                if (currentPage !== 1) {
                    updateHistoryTable(1);
                }
            });
            paginationContainer.appendChild(firstButton);

            // 上一页按钮
            const prevButton = document.createElement('button');
            prevButton.textContent = '上一页';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    updateHistoryTable(currentPage - 1);
                }
            });
            paginationContainer.appendChild(prevButton);

            // 下一页按钮
            const nextButton = document.createElement('button');
            nextButton.textContent = '下一页';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    updateHistoryTable(currentPage + 1);
                }
            });
            paginationContainer.appendChild(nextButton);

            // 尾页按钮
            const lastButton = document.createElement('button');
            lastButton.textContent = '尾页';
            lastButton.disabled = currentPage === totalPages;
            lastButton.addEventListener('click', () => {
                if (currentPage !== totalPages) {
                    updateHistoryTable(totalPages);
                }
            });
            paginationContainer.appendChild(lastButton);

            // 跳转输入框
            const gotoInput = document.createElement('input');
            gotoInput.type = 'number';
            gotoInput.min = 1;
            gotoInput.max = totalPages;
            gotoInput.value = currentPage;
            paginationContainer.appendChild(gotoInput);

            // 跳转按钮
            const gotoButton = document.createElement('button');
            gotoButton.textContent = '跳转';
            gotoButton.addEventListener('click', () => {
                const pageNumber = parseInt(gotoInput.value, 10);
                if (pageNumber >= 1 && pageNumber <= totalPages) {
                    updateHistoryTable(pageNumber);
                }
            });
            paginationContainer.appendChild(gotoButton);
        }

        // 修改tab切换事件，添加表格数据加载
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // 移除所有活动状态
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');

                    // 激活当前tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    const currentTab = document.getElementById(`${tabId}-tab`);
                    currentTab.style.display = 'block';

                    // 如果切换到历史记录标签，更新表格数据
                    if (tabId === 'history') {
                        updateHistoryTable(1);
                    }
                });
            });
        });
        // 修改历史记录查询表单提交事件
        document.getElementById('historyQueryForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = {
                startTime: document.getElementById('historyStartTime').value,
                endTime: document.getElementById('historyEndTime').value,
                monitorPoint: document.getElementById('historyMonitorPoint').value,
                direction: document.getElementById('historyDirection').value,
                shipName: document.getElementById('historyShipName').value
            };

            // 发送查询请求并更新表格
            fetch('/query_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    updateHistoryTable(1); // 查询后显示第一页
                })
                .catch(error => console.error('Error:', error));
        });

        function queryHistoryData(formData) {
            fetch('/query_history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    updateHistoryTable(1);
                })
                .catch(error => console.error('Error:', error));
        }

        // 确保所有初始化函数在页面加载完成后执行
        createShipButtons();
        createOpenDoorSafeUpButtons();
        createOpenDoorSafeDownButtons();
        create_syy_xilanButtons();
        create_syz_xilanButtons();
        create_xyy_xilanButtons();
        create_xyz_xilanButtons();
        createdangerdatasyButtons();
        createdangerdataxyButtons();
        create_floating_Buttons_sy();
        create_floating_Buttons_xy();
        create_cable_Buttons();
        createxychukong();
        createsychukong();
        createxyduizhong();

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // 初始化表格数据
        updateTable(1);
        setInterval(() => updateTable(currentPage), 100000);

        // 初始化模态框事件监听
        const modal = document.getElementById('detailModal');
        const closeButton = document.querySelector('.close-button');

        closeButton.onclick = closeModal;
        window.onclick = function (event) {
            if (event.target === modal) {
                closeModal();
            }
        };

    </script>
    <script src="{{ url_for('static', filename='js/swiper-bundle.min.js') }}"></script>


</body>

</html>